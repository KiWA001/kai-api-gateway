# K-AI API Engineering Guide ðŸ§ 

> **User Instruction**: If you (the AI) are reading this file, it contains the CRITICAL knowledge required to maintain this project. Do not ignore these rules.

---

## 1. System Architecture
The API uses a **Strict Engine** (`engine.py`) that routes requests to providers (`g4f`, `pollinations`).
-   **Adaptive Fallback**: By default (`provider="auto"`), the engine tries models in `MODEL_RANKING` order.
-   **Strict Mode**: If `model` or `provider` is specified, the engine tries **ONLY** that combination. No fallback.

## 2. Deployment

### A. Vercel (Serverless - Default)
Fast, free, but NO browser support (**Z.ai disabled**).
See `vercel.json` and hacks below.

### B. Hugging Face Spaces (Docker - Z.ai Online)
Use this for **Z.ai** (requires browser).
- See [README_DOCKER.md](file:///Users/mac/KAI_API/README_DOCKER.md)
- Supports full browser automation.

### Vercel Deployment Hacks (CRITICAL)
Vercel is a serverless environment with a **Read-Only Filesystem** (except `/tmp`).
Web scraping libraries like `g4f` fail because they try to write cookies/cache to `~/.g4f`.

**The Fix**:
We force the entire application to use `/tmp` as the home directory.
In `main.py` (Top Level):
```python
import os
# Must be set BEFORE importing g4f
if os.environ.get("VERCEL") or True:
    os.environ["HOME"] = "/tmp"
```
**DO NOT REMOVE THIS.** It prevents `[Errno 30] Read-only file system` crashes.

## 3. Provider Specifics

### A. G4F (Scraping Layer)
We use `g4f` to access free AI models via browser masquerading.
-   **User-Agent Rotation**: Every request gets a fresh, random UA (`useragent.py`).
-   **Stateless Clients**: New client per request.
-   **Cookies**: Saved to `/tmp` (via the Vercel fix).

### B. Pollinations (API Layer)
Used for reliable, high-speed models (`gpt-oss-20b`, `mistral`).
-   **No Keys Needed**: It's a free public API (`text.pollinations.ai`).
-   **Stability**: Much more stable than G4F. Used as a fallback or primary for specific models.

### C. Z.ai (Browser-Based Provider)
Uses Playwright Chromium to interact with `chat.z.ai` as a real browser.
-   **Why Browser**: Z.ai uses a proprietary `x-signature` hash generated by obfuscated client-side JS. Rather than reverse-engineering it (fragile), we let the browser execute Z.ai's own JS.
-   **API**: `POST /api/v2/chat/completions` with fingerprint query params.
-   **Auth**: Guest JWT from `GET /api/v1/auths/` (auto, no signup).
-   **Model**: `glm-5` (default, reasoning model), `glm-4-flash`.
-   **Key Headers**: `x-fe-version: prod-fe-1.0.237`, `x-signature: <sha256>`, `Authorization: Bearer <JWT>`.
-   **Speed**: ~5-15s per request (browser startup + DOM scraping).
-   **Vercel**: **DISABLED** (no Chromium in serverless). Local only.
-   **Files**: `providers/zai_provider.py`, `test_zai_browser.py`, `zai_captured.json`.

### D. Gemini (Browser-Based Provider)
Uses Playwright Chromium to interact with `gemini.google.com` as a real browser.
-   **Why Browser**: Interaction mimics a real user session (Guest mode or Incognito).
-   **Input**: `div[contenteditable="true"]`.
-   **Prompt Engineering**: Appends ` ..... answer in plain text` to ensure clean output.
-   **Model**: `gemini-3-flash` (Fast, efficient, web-based).
-   **Files**: `providers/gemini_provider.py`, `test_gemini_browser.py`.
-   **Status**: **Experimental**. Requires local Playwright environment.

### E. HuggingChat (Browser-Based Provider)
Uses Playwright Chromium to interact with `huggingface.co/chat` as a real browser.
-   **Why Browser**: HuggingChat provides access to 100+ open-source models via web interface.
-   **Input**: `textarea` with placeholder text.
-   **Features**: 
    -   Handles the welcome modal automatically (clicks "Start chatting")
    -   Supports model selection from dropdown (optional, defaults to "Omni" router)
    -   Access to top models: Llama 3.3 70B, Qwen 2.5 72B, DeepSeek R1, etc.
-   **Models**: 
    -   `omni` - Auto-routes to best model (default)
    -   `meta-llama/Llama-3.3-70B-Instruct` - Meta's latest Llama model
    -   `Qwen/Qwen2.5-72B-Instruct` - Alibaba's Qwen model
    -   `deepseek-ai/DeepSeek-R1` - DeepSeek reasoning model
-   **Files**: `providers/huggingchat_provider.py`.
-   **Status**: **Experimental**. Requires local Playwright environment.
-   **Vercel**: **DISABLED** (no Chromium in serverless). Local/Docker only.

### F. Search & Deep Research
The API includes a search engine (`search_engine.py`) powered by DuckDuckGo (via `duckduckgo_search`).
-   **`/search`**: Returns raw search results.
-   **`/deep_research`**: Multi-step process:
    1.  Analyzes user query.
    2.  Generates search queries.
    3.  Scrapes results.
    4.  Synthesizes a final answer using the AI Engine.

## 4. Frontend & Admin
-   **`static/docs.html`**: The public landing page AND the "Try It" dashboard.
-   **`static/admin.html`**: Secret admin panel (`/qazmlp`) for checking stats and running tests.
-   **Stats**: Stored in Supabase (persisted across Vercel cold starts).

## 5. Debugging Tools
We have built-in tools to diagnose issues on Vercel:
-   **`/admin/debug_g4f`**: Runs a live G4F test (`gpt-4o-mini`, `gpt-4`) and returns verbose logs.
    -   *Note*: Uses `AsyncClient` to avoid "Event loop already running" errors.
-   **`/admin/test_all`**: Runs a parallel check on all configured models.
-   **`debug_g4f_verbose.py`**: Local script for deep inspection.

## 5. Maintenance Workflows
-   **Adding Models**: Run `@.agent/workflows/update.md`.
    -   *Crucial*: Always run `step 3.6` (Strict Mode Verification) after updates.
-   **Strict Mode Validation**: Run `python3 test_strict.py`.
-   **Future Candidates**:
    -   `chat.z.ai`: **âœ… INTEGRATED** (See Section 3C above).
        -   Previous blocker (x-signature) solved via Playwright browser automation.
        -   Provider: `providers/zai_provider.py`, Model: `glm-5` (Tier 1).

## 6. Common Issues & Fixes
| Error | Cause | Fix |
| :--- | :--- | :--- |
| `[Errno 30] Read-only file system` | `HOME` not set to `/tmp` | Ensure `os.environ["HOME"] = "/tmp"` is at top of `main.py`. |
| `Event loop already running` | Sync `Client` in async handler | Use `g4f.client.AsyncClient`. |
| `Add a "api_key"` | Provider requires auth | The provider (e.g. OpenRouter) is active but we have no key. Use `strict` mode to avoid it, or rely on `ApiAirforce`. |
| `Model not found: auto` | `model="auto"` passed | `engine.py` must handle `model="auto"` as `None`. |

---
**Last Updated**: 2026-02-12
